name: Build and Deploy GitBook
on:
  push:
    branches: [main]
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '10'

      - name: Install GitBook
        run: |
          npm install -g gitbook-cli
          gitbook fetch 3.2.2

      - name: Validate and create missing files
        run: |
          if [ ! -f "SUMMARY.md" ]; then
            echo "# Summary" > SUMMARY.md
            echo "" >> SUMMARY.md
            for file in *.md **/*.md; do
              if [[ "$file" != "README.md" && "$file" != "SUMMARY.md" ]]; then
                title=$(basename "$file" .md | sed 's/-/ /g' | sed 's/\b\w/\U&/g')
                echo "* [$title]($file)" >> SUMMARY.md
              fi
            done
          fi
          if [ -f "SUMMARY.md" ]; then
            grep -oP '\(\K[^)]+\.md(?=\))' SUMMARY.md | sort -u | while read -r file; do
              if [ ! -f "$file" ]; then
                echo "Creating missing: $file"
                title=$(basename "$file" .md | sed 's/-/ /g' | sed 's/\b\w/\U&/g')
                mkdir -p "$(dirname "$file")"
                echo "# $title" > "$file"
                echo "" >> "$file"
                echo "Content under construction." >> "$file"
              fi
            done
          fi

      - name: Create book.json with styles and plugins
        run: |
          cat << 'EOF' > book.json
          {
            "title": "Your Documentation",
            "plugins": [
              "-search",
              "fontsettings",
              "theme-default"
            ],
            "pluginsConfig": {
              "theme-default": {
                "scripts": ["styles/inject-icons.js"]
              },
              "fontsettings": {
                "theme": "white"
              }
            },
            "styles": {
              "website": "styles/website.css"
            }
          }
          EOF

      - name: Add Font Awesome and layout styles
        run: |
          mkdir -p styles
          cat << 'EOF' > styles/website.css
          @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');
          .markdown-section h1 i,
          .markdown-section h2 i,
          .markdown-section h3 i {
            margin-right: 8px;
            font-size: 1em;
            vertical-align: middle;
            color: #555;
          }
          iframe {
            display: block;
            margin: 20px auto;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          }
          .markdown-section blockquote {
            border-left: 4px solid #007acc;
            background: #f8f9fa;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
          }
          .markdown-section blockquote p:first-child { margin-top: 0; }
          .markdown-section blockquote p:last-child { margin-bottom: 0; }
          EOF

      - name: Add icon injection script
        run: |
          cat << 'EOF' > styles/inject-icons.js
          document.addEventListener("DOMContentLoaded", function () {
            const iconMap = {
              "camcorder": "fa-video",
              "terminal": "fa-terminal",
              "rocket": "fa-rocket",
              "settings": "fa-cog",
              "book": "fa-book",
              "api": "fa-code",
              "code": "fa-file-code",
              "image": "fa-image",
              "video": "fa-video",
              "cart": "fa-shopping-cart",
              "search": "fa-magnifying-glass",
              "wishlist": "fa-heart",
              "filter": "fa-sliders",
              "bars": "fa-bars",
              "header": "fa-heading",
              "id-card-clip": "fa-id-card",
              "layer-minus": "fa-layer-group"
            };
            document.querySelectorAll(".summary a").forEach(link => {
              const href = link.getAttribute("href");
              const iconKey = href.replace(".html", "").replace(/\/.*$/, "").toLowerCase();
              const faIcon = iconMap[iconKey];
              if (faIcon && !link.querySelector("i")) {
                link.innerHTML = `<i class="fa-solid ${faIcon}"></i> ` + link.innerHTML;
              }
            });
            document.querySelectorAll(".markdown-section h1, .markdown-section h2, .markdown-section h3").forEach(heading => {
              if (!heading.querySelector("i")) {
                const text = heading.textContent.toLowerCase();
                for (const key in iconMap) {
                  if (text.includes(key)) {
                    heading.innerHTML = `<i class="fa-solid ${iconMap[key]}"></i> ` + heading.innerHTML;
                    break;
                  }
                }
              }
            });
          });
          EOF

      - name: Preprocess markdown files - BULLETPROOF embed/hint/frontmatter removal
        run: |
          find . -type f -name "*.md" -not -path "./node_modules/*" | while read -r file; do
            echo "→ Preprocessing: $file"
            
            # Backup original
            cp "$file" "$file.bak"
            
            # 1. Handle hint blocks FIRST (multi-line safe)
            sed -i '/{% hint style="[^"]*" %}/,/{% endhint %}/c\> **TIP:**' "$file" || true
            sed -i '/{% hint %}/,/{% endhint %}/c\> **INFO:**' "$file" || true
            sed -i 's/{% endhint %}/\n\n/g' "$file"
            
            # 2. Remove ALL variables and frontmatter noise
            sed -i 's/{{[^}]*}}//g' "$file"
            sed -i '/^---/,/^---$/d' "$file"
            
            # 3. BULLETPROOF {% embed %} removal - CATCHES ALL VARIANTS
            # Remove complete embed blocks (multi-line)
            sed -i '/{%\s*embed/,/{%\s*endembed\s*%}/d' "$file" 2>/dev/null || true
            # Remove single-line embeds - ALL possible syntaxes
            sed -i 's/{%\s*embed[^%]*%}//g' "$file"
            sed -i 's/{%\s*embed[^}]*}//g' "$file"
            sed -i 's/{%\s*endembed\s*%}//g' "$file"
            # YouTube conversion (if URL found in embed line before removal)
            perl -i -pe '
              s/(https?:\/\/(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:\S*)?)/<iframe width="560" height="315" src="https:\/\/www.youtube.com\/embed\/$2" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen><\/iframe>/g;
            ' "$file"
            
            # 4. Add frontmatter with icon IF missing
            if ! grep -q '^icon:' "$file"; then
              icon=$(basename "$file" .md | sed 's/\.md$//' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9]/-/g' | sed 's/^-*//;s/-*$//')
              sed -i "1i---\nicon: $icon\n---\n" "$file"
            fi
            
            # 5. Clean up empty lines
            sed -i '/^$/N;/\n$/D' "$file"
          done

      - name: DEBUG - Verify NO embed tags remain
        run: |
          echo "=== CHECKING FOR REMAINING EMBED TAGS ==="
          if grep -r --include="*.md" -i "{%.*embed" . 2>/dev/null; then
            echo "❌ FOUND EMBED TAGS - LISTING:"
            grep -r --include="*.md" -i "{%.*embed" .
            exit 1
          else
            echo "✅ NO EMBED TAGS FOUND - SAFE TO BUILD"
          fi
          echo "Files processed: $(find . -name "*.md" | wc -l)"

      - name: Build GitBook
        run: |
          gitbook install --verbose
          gitbook build --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_book
          force_orphan: true
