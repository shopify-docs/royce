name: Build and Deploy GitBook

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "10"

      - name: Install GitBook
        run: |
          npm install -g gitbook-cli
          gitbook fetch 3.2.2

      - name: Create book.json
        run: |
          cat << 'EOF' > book.json
          {
            "title": "Documentation",
            "plugins": [
              "-search",
              "fontsettings",
              "theme-default"
            ]
          }
          EOF

      - name: Preprocess markdown
        run: |
          find . -type f -name "*.md" | while read -r file; do

            perl -0777 -i -pe '

              # YouTube
              s/{%\s*embed\s+url="https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]{11})[^"]*".*?%}/

<iframe width="100%" height="400" src="https:\/\/www.youtube.com\/embed\/$1" frameborder="0" allowfullscreen><\/iframe>

/gs;

              # MP4
              s/{%\s*embed\s+url="([^"]+\.mp4[^"]*)".*?%}/

<video controls style="width:100%;"><source src="$1" type="video\/mp4"><\/video>

/gs;

            ' "$file"

          done

      - name: Build GitBook
        run: |
          gitbook install
          gitbook build

      - name: Deploy Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_book
          force: true
