name: Build and Deploy GitBook

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # updated to latest version

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '16'  # gitbook-cli works better with newer Node (10 is very old)

      - name: Install GitBook CLI
        run: |
          npm install -g gitbook-cli
          gitbook fetch 3.2.3  # latest 3.x version

      - name: Validate and create missing files
        run: |
          if [ ! -f "SUMMARY.md" ]; then
            echo "# Summary" > SUMMARY.md
            echo "" >> SUMMARY.md
            for file in *.md; do
              if [ "$file" != "README.md" ] && [ "$file" != "SUMMARY.md" ]; then
                title=$(echo "$file" | sed 's/\.md$//' | sed 's/-/ /g' | sed 's/\b\w/\U&/g')
                echo "* [$title]($file)" >> SUMMARY.md
              fi
            done
          fi

          # Create any missing files referenced in SUMMARY.md
          if [ -f "SUMMARY.md" ]; then
            grep -o '\[.*\](.*\.md)' SUMMARY.md | sed 's/.*(\(.*\.md\)).*/\1/' | while read file; do
              if [ ! -f "$file" ]; then
                echo "Creating missing file: $file"
                title=$(echo "$file" | sed 's/\.md$//' | sed 's/-/ /g' | sed 's/\b\w/\U&/g')
                echo "# $title" > "$file"
                echo "" >> "$file"
                echo "This page is under construction." >> "$file"
              fi
            done
          fi

      - name: Create book.json with basic config
        run: |
          cat << 'EOF' > book.json
          {
            "title": "Your Documentation",
            "description": "Documentation built with GitBook",
            "plugins": [
              "-search",
              "fontsettings",
              "theme-default"
            ],
            "pluginsConfig": {
              "fontsettings": {
                "theme": "white",
                "family": "sans",
                "size": 2
              }
            },
            "styles": {
              "website": "styles/website.css"
            }
          }
          EOF

      - name: Add custom styles (Font Awesome + better blockquote/iframe)
        run: |
          mkdir -p styles
          cat << 'EOF' > styles/website.css
          @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css');

          iframe {
            display: block;
            margin: 24px auto;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }

          .markdown-section blockquote {
            border-left: 4px solid #0066cc;
            background: #f8fbff;
            padding: 16px 20px;
            margin: 20px 0;
            border-radius: 6px;
            font-style: italic;
          }

          .markdown-section blockquote p:first-child {
            margin-top: 0;
          }

          .markdown-section blockquote p:last-child {
            margin-bottom: 0;
          }
          EOF

      - name: Preprocess markdown files (remove/fix legacy GitBook tags)
        run: |
          find . -type f -name "*.md" | while read -r file; do
            echo "Preprocessing: $file"

            # Convert hint blocks â†’ blockquote
            sed -i 's/{% hint style="[^"]*" %}/> **TIP:** /g' "$file"
            sed -i 's/{% hint %}/> **NOTE:** /g' "$file"
            sed -i 's/{% endhint %}/\n/g' "$file"

            # Remove Liquid/Handlebars-style variables
            sed -i 's/{{[^}]*}}//g' "$file"

            # Convert YouTube embeds (most common cases)
            # You can extend this regex if you have other embed formats
            perl -i -pe '
              s/{%\s*embed\s+url="https?:\/\/(?:www\.)?youtube\.com\/watch\?v=([^"&]+)[^"]*"\s*%?}/
                "<iframe width=\"560\" height=\"315\" src=\"https:\/\/www.youtube.com\/embed\/$1\" frameborder=\"0\" allowfullscreen><\/iframe>"/gex;

              s/{%\s*embed\s+url="https?:\/\/youtu\.be\/([^"]+)"\s*%?}/
                "<iframe width=\"560\" height=\"315\" src=\"https:\/\/www.youtube.com\/embed\/$1\" frameborder=\"0\" allowfullscreen><\/iframe>"/gex;

              # Fallback: remove any remaining {% embed ... %} tags
              s/{%\s*embed[^%]*%}//g;
            ' "$file"
          done

      - name: Build GitBook
        run: |
          gitbook install --verbose
          gitbook build --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4  # updated to latest
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_book
          force_orphan: true
          # Optional: set a custom domain if you have one
          # cname: docs.yourdomain.com
