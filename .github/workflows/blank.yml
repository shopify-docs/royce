name: Build and Deploy GitBook

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '10'

      - name: Install GitBook CLI
        run: |
          npm install -g gitbook-cli
          gitbook fetch 3.2.2

      - name: Create or update book.json with base path for GitHub Pages
        run: |
          REPO_NAME="${GITHUB_REPOSITORY#*/}"  # e.g. "royce" if repo is username/royce
          echo "Repository name detected: $REPO_NAME"
          
          # Create book.json if it doesn't exist
          if [ ! -f book.json ]; then
            echo "Creating new book.json"
            cat << 'EOF' > book.json
          {
            "title": "Your Documentation",
            "plugins": [
              "-search",
              "fontsettings",
              "theme-default"
            ],
            "pluginsConfig": {
              "fontsettings": {
                "theme": "white"
              }
            },
            "styles": {
              "website": "styles/website.css"
            }
          }
          EOF
          fi

          # Add or update "base" field
          if grep -q '"base"' book.json; then
            sed -i "s|\"base\":.*|\"base\": \"/$REPO_NAME\",|" book.json
          else
            # Insert base before the last closing brace
            sed -i '$ i \  "base": "/'"$REPO_NAME"'",' book.json
            # Fix comma if it's the last property (simple safety)
            sed -i 's/},$/}/' book.json
          fi

          echo "Final book.json content:"
          cat book.json

      - name: Create custom styles (for better video/iframe display)
        run: |
          mkdir -p styles
          cat << 'EOF' > styles/website.css
          video, iframe {
            display: block;
            margin: 24px auto;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          video {
            width: 100%;
            max-width: 900px;
          }
          .markdown-section blockquote {
            border-left: 4px solid #007acc;
            background: #f8f9fa;
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: 4px;
          }
          EOF

      - name: Preprocess markdown files – convert embeds & clean tags
        run: |
          find . -type f -name "*.md" | while read -r file; do
            echo "Processing: $file"

            # Convert GitBook embed for .mp4 files → playable <video> tag
            sed -i 's|{%[[:space:]]*embed[[:space:]]\+url="\([^"]*\.mp4[^"]*\)"[^%]*%}|<video controls preload="metadata" width="100%"><source src="\1" type="video/mp4">Your browser does not support video.</video>|g' "$file"

            # Convert YouTube embeds (if any)
            sed -i 's|{%[[:space:]]*embed[[:space:]]\+url=".*\(youtube\.com\/watch?v=\|youtu\.be\/\)\([a-zA-Z0-9_-]\{11\}\).*%}|<iframe width="560" height="315" src="https://www.youtube.com/embed/\2" frameborder="0" allowfullscreen></iframe>|g' "$file"

            # Remove any remaining embed tags (safety net)
            sed -i 's/{%[[:space:]]*embed[^%]*%}//g' "$file"
            sed -i 's/{%[[:space:]]*end[^%]*%}//g' "$file"

            # Clean hint blocks if present
            sed -i 's/{% hint style="[^"]*" %}/> **Note:** /g' "$file"
            sed -i 's/{% hint %}/> **Note:** /g' "$file"
            sed -i 's/{% endhint %}/\n/g' "$file"

            # Remove variables
            sed -i 's/{{[^}]*}}//g' "$file"
          done

      - name: Debug – check for remaining embed tags
        run: |
          echo "Remaining {% embed %} tags:"
          grep -r --include="*.md" -i "{%.*embed" . || echo "None found – good!"
          echo ""
          echo "Sample from problematic file (should NOT show embed tag):"
          sed -n '20,30p' how-to-instal-theme/how-to-navigate-to-blocks-in-3.0.md || echo "File not found"

      - name: Build GitBook
        run: |
          gitbook install --verbose
          gitbook build --verbose

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_book
          force_orphan: true
          # Optional: if you use a custom domain
          # cname: docs.yourdomain.com
